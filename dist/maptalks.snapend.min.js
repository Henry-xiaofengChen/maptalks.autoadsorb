/*!
 * maptalks.snapend v0.1.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,c){"use strict";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function r(e,t){return e(t={exports:{}},t.exports),t.exports}var s=r(function(e,t){e.exports=function(){function g(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function i(e,t){return e<t?-1:t<e?1:0}return function(e,t,r,n,o){!function e(t,r,n,o,i){for(;n<o;){if(600<o-n){var a=o-n+1,s=r-n+1,u=Math.log(a),l=.5*Math.exp(2*u/3),h=.5*Math.sqrt(u*l*(a-l)/a)*(s-a/2<0?-1:1),c=Math.max(n,Math.floor(r-s*l/a+h)),f=Math.min(o,Math.floor(r+(a-s)*l/a+h));e(t,r,c,f,i)}var d=t[r],m=n,p=o;for(g(t,n,r),0<i(t[o],d)&&g(t,n,o);m<p;){for(g(t,m,p),m++,p--;i(t[m],d)<0;)m++;for(;0<i(t[p],d);)p--}0===i(t[n],d)?g(t,n,p):g(t,++p,o),p<=r&&(n=p+1),r<=p&&(o=p-1)}}(e,t,r||0,n||e.length-1,o||i)}}()}),n=i,o=i;function i(e,t){if(!(this instanceof i))return new i(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function h(e,t,r){if(!r)return t.indexOf(e);for(var n=0;n<t.length;n++)if(r(e,t[n]))return n;return-1}function d(e,t){y(e,0,e.children.length,t,e)}function y(e,t,r,n,o){o||(o=g(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var i,a=t;a<r;a++)i=e.children[a],f(o,e.leaf?n(i):i);return o}function f(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function a(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function v(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function m(e){return e.maxX-e.minX+(e.maxY-e.minY)}function p(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function l(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function b(e,t,r,n,o){for(var i,a=[t,r];a.length;)(r=a.pop())-(t=a.pop())<=n||(i=t+Math.ceil((r-t)/n/2)*n,s(e,i,t,r,o),a.push(t,i,i,r))}i.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],n=this.toBBox;if(!l(e,t))return r;for(var o,i,a,s,u=[];t;){for(o=0,i=t.children.length;o<i;o++)a=t.children[o],l(e,s=t.leaf?n(a):a)&&(t.leaf?r.push(a):p(e,s)?this._all(a,r):u.push(a));t=u.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!l(e,t))return!1;for(var n,o,i,a,s=[];t;){for(n=0,o=t.children.length;n<o;n++)if(i=t.children[n],l(e,a=t.leaf?r(i):i)){if(t.leaf||p(e,a))return!0;s.push(i)}t=s.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var n=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=g([]),this},remove:function(e,t){if(!e)return this;for(var r,n,o,i,a=this.data,s=this.toBBox(e),u=[],l=[];a||u.length;){if(a||(a=u.pop(),n=u[u.length-1],r=l.pop(),i=!0),a.leaf&&-1!==(o=h(e,a.children,t)))return a.children.splice(o,1),u.push(a),this._condense(u),this;i||a.leaf||!p(a,s)?n?(r++,a=n.children[r],i=!1):a=null:(u.push(a),l.push(r),r=0,a=(n=a).children[0])}return this},toBBox:function(e){return e},compareMinX:a,compareMinY:u,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,n){var o,i=r-t+1,a=this._maxEntries;if(i<=a)return d(o=g(e.slice(t,r+1)),this.toBBox),o;n||(n=Math.ceil(Math.log(i)/Math.log(a)),a=Math.ceil(i/Math.pow(a,n-1))),(o=g([])).leaf=!1,o.height=n;var s,u,l,h,c=Math.ceil(i/a),f=c*Math.ceil(Math.sqrt(a));for(b(e,t,r,f,this.compareMinX),s=t;s<=r;s+=f)for(b(e,s,l=Math.min(s+f-1,r),c,this.compareMinY),u=s;u<=l;u+=c)h=Math.min(u+c-1,l),o.children.push(this._build(e,u,h,n-1));return d(o,this.toBBox),o},_chooseSubtree:function(e,t,r,n){for(var o,i,a,s,u,l,h,c,f,d;n.push(t),!t.leaf&&n.length-1!==r;){for(h=c=1/0,o=0,i=t.children.length;o<i;o++)u=v(a=t.children[o]),f=e,d=a,(l=(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-u)<c?(c=l,h=u<h?u:h,s=a):l===c&&u<h&&(h=u,s=a);t=s||t.children[0]}return t},_insert:function(e,t,r){var n=this.toBBox,o=r?e:n(e),i=[],a=this._chooseSubtree(o,this.data,t,i);for(a.children.push(e),f(a,o);0<=t&&i[t].children.length>this._maxEntries;)this._split(i,t),t--;this._adjustParentBBoxes(o,i,t)},_split:function(e,t){var r=e[t],n=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,n);var i=this._chooseSplitIndex(r,o,n),a=g(r.children.splice(i,r.children.length-i));a.height=r.height,a.leaf=r.leaf,d(r,this.toBBox),d(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(r,a)},_splitRoot:function(e,t){this.data=g([e,t]),this.data.height=e.height+1,this.data.leaf=!1,d(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var n,o,i,a,s,u,l,h,c,f,d,m,p,g;for(u=l=1/0,n=t;n<=r-t;n++)o=y(e,0,n,this.toBBox),i=y(e,n,r,this.toBBox),c=o,f=i,void 0,d=Math.max(c.minX,f.minX),m=Math.max(c.minY,f.minY),p=Math.min(c.maxX,f.maxX),g=Math.min(c.maxY,f.maxY),a=Math.max(0,p-d)*Math.max(0,g-m),s=v(o)+v(i),a<u?(u=a,h=n,l=s<l?s:l):a===u&&s<l&&(l=s,h=n);return h},_chooseSplitAxis:function(e,t,r){var n=e.leaf?this.compareMinX:a,o=e.leaf?this.compareMinY:u;this._allDistMargin(e,t,r,n)<this._allDistMargin(e,t,r,o)&&e.children.sort(n)},_allDistMargin:function(e,t,r,n){e.children.sort(n);var o,i,a=this.toBBox,s=y(e,0,t,a),u=y(e,r-t,r,a),l=m(s)+m(u);for(o=t;o<r-t;o++)i=e.children[o],f(s,e.leaf?a(i):i),l+=m(s);for(o=r-t-1;t<=o;o--)i=e.children[o],f(u,e.leaf?a(i):i),l+=m(u);return l},_adjustParentBBoxes:function(e,t,r){for(var n=r;0<=n;n--)f(t[n],e)},_condense:function(e){for(var t,r=e.length-1;0<=r;r--)0===e[r].children.length?0<r?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():d(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}},n.default=o;var _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},w=r(function(e,i){function s(e,t,r){void 0===r&&(r={});var n={type:"Feature"};return(0===r.id||r.id)&&(n.id=r.id),r.bbox&&(n.bbox=r.bbox),n.properties=t||{},n.geometry=e,n}function n(e,t,r){return void 0===r&&(r={}),s({type:"Point",coordinates:e},t,r)}function o(e,t,r){void 0===r&&(r={});for(var n=0,o=e;n<o.length;n++){var i=o[n];if(i.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var a=0;a<i[i.length-1].length;a++)if(i[i.length-1][a]!==i[0][a])throw new Error("First and last Position are not equivalent.")}return s({type:"Polygon",coordinates:e},t,r)}function a(e,t,r){if(void 0===r&&(r={}),e.length<2)throw new Error("coordinates must be an array of two or more positions");return s({type:"LineString",coordinates:e},t,r)}function u(e,t){void 0===t&&(t={});var r={type:"FeatureCollection"};return t.id&&(r.id=t.id),t.bbox&&(r.bbox=t.bbox),r.features=e,r}function l(e,t,r){return void 0===r&&(r={}),s({type:"MultiLineString",coordinates:e},t,r)}function h(e,t,r){return void 0===r&&(r={}),s({type:"MultiPoint",coordinates:e},t,r)}function c(e,t,r){return void 0===r&&(r={}),s({type:"MultiPolygon",coordinates:e},t,r)}function f(e,t){void 0===t&&(t="kilometers");var r=i.factors[t];if(!r)throw new Error(t+" units is invalid");return e*r}function d(e,t){void 0===t&&(t="kilometers");var r=i.factors[t];if(!r)throw new Error(t+" units is invalid");return e/r}function r(e){return 180*(e%(2*Math.PI))/Math.PI}function t(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)&&!/^\s*$/.test(e)}Object.defineProperty(i,"__esModule",{value:!0}),i.earthRadius=6371008.8,i.factors={centimeters:100*i.earthRadius,centimetres:100*i.earthRadius,degrees:i.earthRadius/111325,feet:3.28084*i.earthRadius,inches:39.37*i.earthRadius,kilometers:i.earthRadius/1e3,kilometres:i.earthRadius/1e3,meters:i.earthRadius,metres:i.earthRadius,miles:i.earthRadius/1609.344,millimeters:1e3*i.earthRadius,millimetres:1e3*i.earthRadius,nauticalmiles:i.earthRadius/1852,radians:1,yards:i.earthRadius/1.0936},i.unitsFactors={centimeters:100,centimetres:100,degrees:1/111325,feet:3.28084,inches:39.37,kilometers:.001,kilometres:.001,meters:1,metres:1,miles:1/1609.344,millimeters:1e3,millimetres:1e3,nauticalmiles:1/1852,radians:1/i.earthRadius,yards:1/1.0936},i.areaFactors={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046},i.feature=s,i.geometry=function(e,t,r){switch(void 0===r&&(r={}),e){case"Point":return n(t).geometry;case"LineString":return a(t).geometry;case"Polygon":return o(t).geometry;case"MultiPoint":return h(t).geometry;case"MultiLineString":return l(t).geometry;case"MultiPolygon":return c(t).geometry;default:throw new Error(e+" is invalid")}},i.point=n,i.points=function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return n(e,t)}),r)},i.polygon=o,i.polygons=function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return o(e,t)}),r)},i.lineString=a,i.lineStrings=function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return a(e,t)}),r)},i.featureCollection=u,i.multiLineString=l,i.multiPoint=h,i.multiPolygon=c,i.geometryCollection=function(e,t,r){return void 0===r&&(r={}),s({type:"GeometryCollection",geometries:e},t,r)},i.round=function(e,t){if(void 0===t&&(t=0),t&&!(0<=t))throw new Error("precision must be a positive number");var r=Math.pow(10,t||0);return Math.round(e*r)/r},i.radiansToLength=f,i.lengthToRadians=d,i.lengthToDegrees=function(e,t){return r(d(e,t))},i.bearingToAzimuth=function(e){var t=e%360;return t<0&&(t+=360),t},i.radiansToDegrees=r,i.degreesToRadians=function(e){return e%360*Math.PI/180},i.convertLength=function(e,t,r){if(void 0===t&&(t="kilometers"),void 0===r&&(r="kilometers"),!(0<=e))throw new Error("length must be a positive number");return f(d(e,t),r)},i.convertArea=function(e,t,r){if(void 0===t&&(t="meters"),void 0===r&&(r="kilometers"),!(0<=e))throw new Error("area must be a positive number");var n=i.areaFactors[t];if(!n)throw new Error("invalid original units");var o=i.areaFactors[r];if(!o)throw new Error("invalid final units");return e/n*o},i.isNumber=t,i.isObject=function(e){return!!e&&e.constructor===Object},i.validateBBox=function(e){if(!e)throw new Error("bbox is required");if(!Array.isArray(e))throw new Error("bbox must be an Array");if(4!==e.length&&6!==e.length)throw new Error("bbox must be an Array of 4 or 6 numbers");e.forEach(function(e){if(!t(e))throw new Error("bbox must only contain numbers")})},i.validateId=function(e){if(!e)throw new Error("id is required");if(-1===["string","number"].indexOf(void 0===e?"undefined":_(e)))throw new Error("id must be a number or a string")},i.radians2degrees=function(){throw new Error("method has been renamed to `radiansToDegrees`")},i.degrees2radians=function(){throw new Error("method has been renamed to `degreesToRadians`")},i.distanceToDegrees=function(){throw new Error("method has been renamed to `lengthToDegrees`")},i.distanceToRadians=function(){throw new Error("method has been renamed to `lengthToRadians`")},i.radiansToDistance=function(){throw new Error("method has been renamed to `radiansToLength`")},i.bearingToAngle=function(){throw new Error("method has been renamed to `bearingToAzimuth`")},i.convertDistance=function(){throw new Error("method has been renamed to `convertLength`")}});t(w);var x=r(function(e,t){function x(e,t,r){if(null!==e)for(var n,o,i,a,s,u,l,h,c=0,f=0,d=e.type,m="FeatureCollection"===d,p="Feature"===d,g=m?e.features.length:1,y=0;y<g;y++){s=(h=!!(l=m?e.features[y].geometry:p?e.geometry:e)&&"GeometryCollection"===l.type)?l.geometries.length:1;for(var v=0;v<s;v++){var b=0,_=0;if(null!==(a=h?l.geometries[v]:l)){u=a.coordinates;var w=a.type;switch(c=!r||"Polygon"!==w&&"MultiPolygon"!==w?0:1,w){case null:break;case"Point":if(!1===t(u,f,y,b,_))return!1;f++,b++;break;case"LineString":case"MultiPoint":for(n=0;n<u.length;n++){if(!1===t(u[n],f,y,b,_))return!1;f++,"MultiPoint"===w&&b++}"LineString"===w&&b++;break;case"Polygon":case"MultiLineString":for(n=0;n<u.length;n++){for(o=0;o<u[n].length-c;o++){if(!1===t(u[n][o],f,y,b,_))return!1;f++}"MultiLineString"===w&&b++,"Polygon"===w&&_++}"Polygon"===w&&b++;break;case"MultiPolygon":for(n=0;n<u.length;n++){for(o=_=0;o<u[n].length;o++){for(i=0;i<u[n][o].length-c;i++){if(!1===t(u[n][o][i],f,y,b,_))return!1;f++}_++}b++}break;case"GeometryCollection":for(n=0;n<a.geometries.length;n++)if(!1===x(a.geometries[n],t,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function i(e,t){var r;switch(e.type){case"FeatureCollection":for(r=0;r<e.features.length&&!1!==t(e.features[r].properties,r);r++);break;case"Feature":t(e.properties,0)}}function a(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(var r=0;r<e.features.length&&!1!==t(e.features[r],r);r++);}function r(e,t){var r,n,o,i,a,s,u,l,h,c,f=0,d="FeatureCollection"===e.type,m="Feature"===e.type,p=d?e.features.length:1;for(r=0;r<p;r++){for(s=d?e.features[r].geometry:m?e.geometry:e,l=d?e.features[r].properties:m?e.properties:{},h=d?e.features[r].bbox:m?e.bbox:void 0,c=d?e.features[r].id:m?e.id:void 0,a=(u=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,o=0;o<a;o++)if(null!==(i=u?s.geometries[o]:s))switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(i,f,l,h,c))return!1;break;case"GeometryCollection":for(n=0;n<i.geometries.length;n++)if(!1===t(i.geometries[n],f,l,h,c))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===t(null,f,l,h,c))return!1;f++}}function s(e,l){r(e,function(e,t,r,n,o){var i,a=null===e?null:e.type;switch(a){case null:case"Point":case"LineString":case"Polygon":return!1!==l(w.feature(e,r,{bbox:n,id:o}),t,0)&&void 0}switch(a){case"MultiPoint":i="Point";break;case"MultiLineString":i="LineString";break;case"MultiPolygon":i="Polygon"}for(var s=0;s<e.coordinates.length;s++){var u={type:i,coordinates:e.coordinates[s]};if(!1===l(w.feature(u,r),t,s))return!1}})}function n(e,m){s(e,function(a,s,u){var l=0;if(a.geometry){var e=a.geometry.type;if("Point"!==e&&"MultiPoint"!==e){var h,c=0,f=0,d=0;return!1!==x(a,function(e,t,r,n,o){if(void 0===h||c<s||f<n||d<o)return h=e,c=s,f=n,d=o,void(l=0);var i=w.lineString([h,e],a.properties);if(!1===m(i,s,u,o,l))return!1;l++,h=e})&&void 0}}})}function u(e,a){if(!e)throw new Error("geojson is required");s(e,function(e,t,r){if(null!==e.geometry){var n=e.geometry.type,o=e.geometry.coordinates;switch(n){case"LineString":if(!1===a(e,t,r,0,0))return!1;break;case"Polygon":for(var i=0;i<o.length;i++)if(!1===a(w.lineString(o[i],e.properties),t,r,i))return!1}}})}Object.defineProperty(t,"__esModule",{value:!0}),t.coordEach=x,t.coordReduce=function(e,i,a,t){var s=a;return x(e,function(e,t,r,n,o){s=0===t&&void 0===a?e:i(s,e,t,r,n,o)},t),s},t.propEach=i,t.propReduce=function(e,r,n){var o=n;return i(e,function(e,t){o=0===t&&void 0===n?e:r(o,e,t)}),o},t.featureEach=a,t.featureReduce=function(e,r,n){var o=n;return a(e,function(e,t){o=0===t&&void 0===n?e:r(o,e,t)}),o},t.coordAll=function(e){var t=[];return x(e,function(e){t.push(e)}),t},t.geomEach=r,t.geomReduce=function(e,i,a){var s=a;return r(e,function(e,t,r,n,o){s=0===t&&void 0===a?e:i(s,e,t,r,n,o)}),s},t.flattenEach=s,t.flattenReduce=function(e,n,o){var i=o;return s(e,function(e,t,r){i=0===t&&0===r&&void 0===o?e:n(i,e,t,r)}),i},t.segmentEach=n,t.segmentReduce=function(e,i,a){var s=a,u=!1;return n(e,function(e,t,r,n,o){s=!1===u&&void 0===a?e:i(s,e,t,r,n,o),u=!0}),s},t.lineEach=u,t.lineReduce=function(e,o,i){var a=i;return u(e,function(e,t,r,n){a=0===t&&void 0===i?e:o(a,e,t,r,n)}),a},t.findSegment=function(e,t){if(t=t||{},!w.isObject(t))throw new Error("options is invalid");var r,n=t.featureIndex||0,o=t.multiFeatureIndex||0,i=t.geometryIndex||0,a=t.segmentIndex||0,s=t.properties;switch(e.type){case"FeatureCollection":n<0&&(n=e.features.length+n),s=s||e.features[n].properties,r=e.features[n].geometry;break;case"Feature":s=s||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":case"MultiPoint":return null;case"LineString":return a<0&&(a=u.length+a-1),w.lineString([u[a],u[a+1]],s,t);case"Polygon":return i<0&&(i=u.length+i),a<0&&(a=u[i].length+a-1),w.lineString([u[i][a],u[i][a+1]],s,t);case"MultiLineString":return o<0&&(o=u.length+o),a<0&&(a=u[o].length+a-1),w.lineString([u[o][a],u[o][a+1]],s,t);case"MultiPolygon":return o<0&&(o=u.length+o),i<0&&(i=u[o].length+i),a<0&&(a=u[o][i].length-a-1),w.lineString([u[o][i][a],u[o][i][a+1]],s,t)}throw new Error("geojson is invalid")},t.findPoint=function(e,t){if(t=t||{},!w.isObject(t))throw new Error("options is invalid");var r,n=t.featureIndex||0,o=t.multiFeatureIndex||0,i=t.geometryIndex||0,a=t.coordIndex||0,s=t.properties;switch(e.type){case"FeatureCollection":n<0&&(n=e.features.length+n),s=s||e.features[n].properties,r=e.features[n].geometry;break;case"Feature":s=s||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":return w.point(u,s,t);case"MultiPoint":return o<0&&(o=u.length+o),w.point(u[o],s,t);case"LineString":return a<0&&(a=u.length+a),w.point(u[a],s,t);case"Polygon":return i<0&&(i=u.length+i),a<0&&(a=u[i].length+a),w.point(u[i][a],s,t);case"MultiLineString":return o<0&&(o=u.length+o),a<0&&(a=u[o].length+a),w.point(u[o][a],s,t);case"MultiPolygon":return o<0&&(o=u.length+o),i<0&&(i=u[o].length+i),a<0&&(a=u[o][i].length-a),w.point(u[o][i][a],s,t)}throw new Error("geojson is invalid")}});t(x);var M=r(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=[1/0,1/0,-1/0,-1/0];return x.coordEach(e,function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])}),t}});t(M);var P=M.default,E=x.featureEach,S=w.featureCollection;function k(e){var t=n(e);return t.insert=function(e){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox?e.bbox:P(e),n.prototype.insert.call(this,e)},t.load=function(e){var t=[];return Array.isArray(e)?e.forEach(function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox?e.bbox:P(e),t.push(e)}):E(e,function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox?e.bbox:P(e),t.push(e)}),n.prototype.load.call(this,t)},t.remove=function(e,t){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox?e.bbox:P(e),n.prototype.remove.call(this,e,t)},t.clear=function(){return n.prototype.clear.call(this)},t.search=function(e){var t=n.prototype.search.call(this,this.toBBox(e));return S(t)},t.collides=function(e){return n.prototype.collides.call(this,this.toBBox(e))},t.all=function(){var e=n.prototype.all.call(this);return S(e)},t.toJSON=function(){return n.prototype.toJSON.call(this)},t.fromJSON=function(e){return n.prototype.fromJSON.call(this,e)},t.toBBox=function(e){var t;if(e.bbox)t=e.bbox;else if(Array.isArray(e)&&4===e.length)t=e;else if(Array.isArray(e)&&6===e.length)t=[e[0],e[1],e[3],e[4]];else if("Feature"===e.type)t=P(e);else{if("FeatureCollection"!==e.type)throw new Error("invalid geojson");t=P(e)}return{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}},t}var T=k,C=k;function B(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):function(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var o=r[n],i=Object.getOwnPropertyDescriptor(t,o);i&&i.configurable&&void 0===e[o]&&Object.defineProperty(e,o,i)}}(e,t))}T.default=C;var X=function(r){function n(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,r.call(this,e));return t.tree=T(),t._distance=10,t}return B(n,r),n.prototype.setLayer=function(e){var t=this;return e instanceof c.VectorLayer&&(this.snaplayer=e,this.addTo(e.map),this.snaplayer.on("addgeo",function(){return t._updateGeosSet()},this),this.snaplayer.on("clear",function(){return t._resetGeosSet()},this),this._mousemoveLayer.bringToFront(),this.bindDrawTool(e.map._map_tool)),this},n.prototype.bindDrawTool=function(e){var t=this;e instanceof c.DrawTool&&((this.drawTool=e).on("enable",function(e){return t.enable()},this),e.on("disable",function(e){return t.disable()},this),e.on("remove",function(e){return t.remove()},this),e.isEnabled()&&this.enable())},n.prototype.enable=function(){return this._updateGeosSet(),this._registerMapEvents(),this._registerDrawToolEvents(),this._mousemoveLayer.show(),this},n.prototype.disable=function(){return this._offMapEvents(),this._offDrawToolEvents(),delete this._mousemove,delete this._mousedown,delete this._mouseup,this._mousemoveLayer.hide(),this._resetGeosSet(),this},n.prototype.remove=function(){this.disable(),this._marker.remove(),this._mousemoveLayer.remove(),delete this.drawTool,delete this._marker,delete this._mousemoveLayer},n.prototype.addTo=function(e){var t=c.INTERNAL_LAYER_PREFIX+"_snapendpoint";return this._mousemoveLayer=new c.VectorLayer(t).addTo(e),this._map=e,this._resetGeosSet(),this},n.prototype._updateGeosSet=function(){var t=this,e=this.snaplayer.getGeometries(),r=[];e.forEach(function(e){return r.push.apply(r,t._parserToPoints(e))}),this._geosSet=r},n.prototype._parserToPoints=function(e){var t=this,r=e.getType(),n="Circle"===r||"Ellipse"===r?e.getShell():e.getCoordinates(),o=[],i=n[0]instanceof Array;(i&&n.forEach(function(e){return o.push.apply(o,t._createMarkers(e))}),i)||(n instanceof Array||(n=[n]),o.push.apply(o,this._createMarkers(n)));return o},n.prototype._createMarkers=function(e){var t=[];return e.forEach(function(e){return t.push(new c.Marker(e,{properties:{}}).toGeoJSON())}),t},n.prototype._resetGeosSet=function(){this._geosSet=[]},n.prototype._registerMapEvents=function(){var t=this;if(!this._mousemove){var e=this._map;this._mousemove=function(e){return t._mousemoveEvents(e)},this._mousedown=function(){return t._needFindGeometry=!1},this._mouseup=function(){return t._needFindGeometry=!0},e.on("mousemove touchstart",this._mousemove,this),e.on("mousedown",this._mousedown,this),e.on("mouseup",this._mouseup,this)}},n.prototype._offMapEvents=function(){var e=this._map;e.off("mousemove touchstart",this._mousemove,this),e.off("mousedown",this._mousedown,this),e.off("mouseup",this._mouseup,this)},n.prototype._mousemoveEvents=function(e){var t=e.coordinate;this._mousePoint=t;var r=!!this._marker;r&&this._marker.setCoordinates(t),r||(this._marker=new c.Marker(t,{symbol:{}}).addTo(this._mousemoveLayer)),this._updateSnapPoint(t)},n.prototype._updateSnapPoint=function(e){if(this._needFindGeometry){var t=this._findGeometry(e);if(this.snapPoint=0<t.features.length?this._getSnapPoint(t):null,this.snapPoint){var r=this.snapPoint,n=r.x,o=r.y;this._marker.setCoordinates([n,o])}}},n.prototype._findGeometry=function(e){if(this._geosSet){var t=this._geosSet;return this.tree.clear(),this.tree.load({type:"FeatureCollection",features:t}),this.inspectExtent=this._createInspectExtent(e),this.tree.search(this.inspectExtent)}return null},n.prototype._createInspectExtent=function(e){var t=this._distance,r=this._map,n=r.getZoom(),o=r.coordinateToPoint(e,n),i=o.x,a=o.y,s=r.pointToCoordinate(new c.Point([i-t,a-t]),n),u=r.pointToCoordinate(new c.Point([i+t,a-t]),n),l=r.pointToCoordinate(new c.Point([i-t,a+t]),n),h=r.pointToCoordinate(new c.Point([i+t,a+t]),n);return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[s.x,s.y],[u.x,u.y],[h.x,h.y],[l.x,l.y]]]}}},n.prototype._getSnapPoint=function(e){var t=this._findNearestGeometries(e.features).geoObject.geometry.coordinates;return{x:t[0],y:t[1]}},n.prototype._findNearestGeometries=function(e){var t=this._setDistance(e);return(t=t.sort(this._compare(t,"distance")))[0]},n.prototype._setDistance=function(e){var r=this,n=[];return e.forEach(function(e){var t=r._distToPoint(e);n.push({geoObject:e,distance:t})}),n},n.prototype._distToPoint=function(e){var t=this._mousePoint,r=[t.x,t.y],n=e.geometry.coordinates;return Math.sqrt(Math.pow(r[0]-n[0],2)+Math.pow(r[1]-n[1],2))},n.prototype._compare=function(e,n){return function(e,t){var r=e[n];return t[n]<r}},n.prototype._registerDrawToolEvents=function(){var t=this,e=this.drawTool;e.on("drawstart",function(e){return t._resetCoordsAndPoint(e)},this),e.on("mousemove",function(e){return t._resetCoordinates(e.target._geometry)},this),e.on("drawvertex",function(e){return t._resetCoordsAndPoint(e)},this),e.on("drawend",function(e){return t._resetCoordinates(e.geometry)},this)},n.prototype._offDrawToolEvents=function(){var t=this;if(this.drawTool){var e=this.drawTool;e.off("drawstart",function(e){return t._resetCoordsAndPoint(e)},this),e.off("mousemove",function(e){return t._resetCoordinates(e.target._geometry)},this),e.off("drawvertex",function(e){return t._resetCoordsAndPoint(e)},this),e.off("drawend",function(e){return t._resetCoordinates(e.geometry)},this)}},n.prototype._resetCoordsAndPoint=function(e){this._resetCoordinates(e.target._geometry),this._resetClickPoint(e.target._clickCoords)},n.prototype._resetCoordinates=function(e){if(this.snapPoint){var t=this.snapPoint,r=t.x,n=t.y,o=e.getCoordinates(),i=o.length;return i&&(o[i-1].x=r,o[i-1].y=n),e.setCoordinates(o),e}},n.prototype._resetClickPoint=function(e){if(this.snapPoint){var t=this.snapPoint,r=t.x,n=t.y,o=e.length;e[o-1].x=r,e[o-1].y=n}},n}(c.Class);X.mergeOptions({}),e.SnapEndPoint=X,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.snapend v0.1.0")});